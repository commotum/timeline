                  stage, the context window is dynamically extended        interpolated or extrapolated distribution and the
                  via fine-tuning or tuning-free position interpolation    original one. Finally, we determine the most ap-
                  strategies (Chen et al., 2023; Peng et al., 2023; Liu    propriate extension strategy for each rotary angle
                  et al., 2023) on the rotary position embedding.          dimension independently.
                    However, these position interpolation strategies          Experiments across LLMs of different sizes and
                  primarily rely on intuition and are developed from       various long-context tasks demonstrate the effec-
                  an empirical perspective, resulting in a lack of in-     tiveness of our distributional approach. We outper-
                  terpretability (Zhao et al., 2023) and sub-optimal       form the strong extension baselines PI (Chen et al.,
                  performanceforcontextextension. Forexample,PI            2023)andYaRN(Pengetal.,2023)onLongBench-
                  (Chen et al., 2023) equally stretches all dimensions     E(Baietal.,2023),achievinganewstate-of-the-art.
                  oftheRoPEwiththecontextextensionratio. YaRN              Besides, our method achieves 100% accuracy on
                  (Peng et al., 2023) observes that heuristically uti-     passkey retrieval (Mohtashami and Jaggi, 2023)
                  lizing different strategies for different dimensions     and matches the performance of original LLMs on
                  yields better performance. However, the reasons          short-text tasks in the HuggingFace Open LLM
                  behind this phenomenon have not been thoroughly          Leaderboard (Face, 2023). In summary, our contri-
                  investigated, resulting in it likely not achieving the   butions are as follows:
                  best results. Moreover, the optimal hyperparame-            • Wearethefirst, to the best of our knowledge,
                  ters determinedexperimentallyinYaRNpotentially                to analyze the context window extension from
                  hinder its generalization to new model settings.              a distributional perspective, where rotary an-
                    Tobridge the gap between experiments and the-               gle distributions are observed to be crucial.
                  oretical analysis, we tackle context window ex-
                  tension from the view of rotary angle distribution.         • We propose a novel method to minimize the
                  Hence, we propose a method for length extension               perturbation to the distribution when applying
                  strategy selection, which has the potential to be the-        position interpolation for context extension.
                  oretically optimal by minimizing the perturbation
                  to the rotary angle distributions of the pre-trained        • Experimental results demonstrate that we can
                  language model. Specifically, we first compare                surpass existing long-text extension methods
                  the pre-training rotary angle distribution with the           onbothlong-text and short-text benchmarks.
                  distributions introduced by interpolation and ex-        2 Preliminaries
                  trapolation. As illustrated in Figure 1(a), interpo-
                  lation can introduce too many OOD angles that            2.1   Rotary Position Embedding (RoPE)
                  have a frequency of 0 in the pre-training distri-        Rotary position embedding (Su et al., 2021) is a
                  bution, indicating a significant disturbance to the      position embedding method widely used in recent
                  original distribution and posing a challenge for the     LLMs,whichhaveweakextrapolationproperties
                  model to adapt to the new distribution. While di-        for long text modeling and context window exten-
                  rect extrapolation may have a negligible impact on       sion. As demonstrated in the upper part of Fig-
                  the distribution. Contrarily in another dimension        ure 2, OOD position indices can be directly ex-
                  demonstrated in Figure 1(b), direct extrapolation        trapolated when corresponding rotary angles are
                  introduces numerous OOD angles in this situation,        periodic. Given a d-dimensional attention head, the
                  causing a severe distribution disturbance, whereas       mthtoken’s rotary matrix Rd is defined:
                  interpolation performs better.                                                         m
                    Fromsuchdistributional view, we find that the                                                           
                                                                                      ..  ..      0            0        0 0
                  consistency between the pre-training rotary angle                                                         
                                                                                      ..  ..      0            0        0 0
                                                                                                                            
                  distribution and the extension distribution varies                0 0 cos(mθ ) 9sin(mθ ) 0 0
                                                                            Rd =                     i             i        
                  across different dimensions. Thus, we propose to             m    0 0 sin(mθi)          cos(mθi)     0 0
                                                                                                                            
                  employ different extension strategies in different                                                        
                                                                                      0 0         0            0        ..  ..
                  dimensions according to the rotary angle distri-                    0 0         0            0        ..  ..
                  bution. We first approximate the distributions of                                                          (1)
                                                                                                                     92i
                  rotary angles by calculating the frequency of angles     where i ∈ [0,d/2 − 1] and θi = 10000 d , where
                  in minimal discrete intervals. Then, we estimate         the hyperparameter 10000 is the default base of
                  the disturbance introduced by different extension        RoPE (Su et al., 2021). Suppose the input of a
                                                                                                                      d
                  strategies by computing the distance between the         single attention head is x ,··· ,x ∈ R , where l
                                                                                                      1        l
                                                                       7289
