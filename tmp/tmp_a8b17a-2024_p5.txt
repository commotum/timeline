                           Full proof is given in Appendix E.3. This theorem suggests that for existing LLMs relying on PE,
                           simply weaving its relative positional encoding can effectively extend the input window.
                           Through Theorem 3.1 and Theorem 3.2, we formulate pertinent theoretical models for NoPE and
                           PE, respectively, shedding light on the intricate relationship between extrapolation and the effective
                           windowlength. Building upon these findings, Theorem 3.3 delves deeper into the realm of explicit
                           PE, revealing that a well-designed weave PE scheme can effectively broaden the original effective
                           windowlength. The theorems show the existence of an effective length M, which is typically related
                           to the maximum training window length of the LLM. Furthermore, within the proof of Theorem 3.3,
                           our results indicate that N ≪ M, consistent to experimental findings in Su (2023b), where although
                           the extrapolation position can theoretically start from 2048, the best extrapolation starting position is
                           512. More experimental parameters also validate this setting (refer to Appendix B.2).
                           3.4  Validating Extrapolation Using Observed Thresholds
                           Further, we design probe experiments (refer to Appendix F.3 for more results) to validate the observed
                           phenomena and our theorems, as shown in Figure 2. From Figure 2, two observations are noted:
                           Firstly, for hidden state values of the same dimension, the first layer undergoes minimal change,
                           while the second layer exhibits a more pronounced transition. Exceeding the threshold implies
                           extrapolation failure. This observation aligns with our theoretical model construction, where the first
                           layer primarily refines positional information, with significant signal changes occurring in the second
                           layer, as demonstrated in Theorem 3.2. Secondly, based on observational thresholds, when the length
                           of the input sequence is around 12k, the values of hidden state corresponding to Dynamic-NTK
                           Liu et al. (2023) surpass the threshold, implying extrapolation failure. Conversely, for ReRoPE
                           Su (2023b), extrapolation succeeds. These two predictive outcomes corroborate with subsequent
                           experimental results.
                           Figure 2: Thresholds for hidden states observed at specific dimensions on LLaMA2-7B-Chat, allowing for
                           extrapolative judgments based on these thresholds. The vertical black dashed line indicate the position of
                           maximumtraininglengthofthemodel. Inthis case, it is 4k for LLaMA2-7B-Chat model. The hidden state value
                           at this position is designated as the observed threshold and marked with a horizontal red dashed line. When the
                           hidden state value exceeds the red dashed line as the position changes, it signifies that the hidden state value has
                           surpassed the threshold, suggesting a failure in extrapolation after that position.
                           4   Mesa-Extrapolation
                           In this section, we begin by introducing a novel weave position encoding method, termed Stair
                           Position Encoding (Stair PE). Following this, we propose a chunk-based triangular attention matrix.
                           Building on these concepts, we introduce the implementation of Mesa-Extrapolation. Lastly, we
                           discuss the theoretical properties of these innovations.
                           4.1  Stair PE
                           Following the concept of weave PE in Equ.2, we define a novel weave PE method, namely Stair PE
                           as follows:
                           ⟨q ,k ⟩ := f       (q ,k ,t − i) = f (q ,k ,W(t−i)), and W(t−i) :=  t−i         ,  t −i ≤ N
                             t  i     StairPE  t  i          PE t i                                      I  ,  t −i > N
                                                                                                                        (3)
                                                                          5
