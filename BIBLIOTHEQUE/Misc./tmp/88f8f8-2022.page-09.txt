                                                                                                               Point Primitive Transformer                     9
                                             where (x,y,z) âˆˆ P and (Î´ ,Î´ ,Î´ ,Î´ ) is spatial-temporal offset of kernel and Â·
                                                                         t           x   y    z   t
                                             is matrix multiplication. f(x,y,z) âˆˆ RCÃ—1 is the feature of point at (x,y,z,t),
                                                                                    t       P
                                             and the temporal aggregation                        is implemented with sum-pooling and the
                                             spatial P is max-pooling. r and r represent temporal and spatial radius.
                                                                                        s           t
                                             W Â·(Î´ ,Î´ ,Î´ ,Î´ )T generates offset weights where W                                    âˆˆ RCâ€²Ã—4 transforms
                                                 d       x   y    z   t                                                        d
                                                                                  4Ã—1         Câ€²Ã—1                      Câ€²Ã—C
                                             4Ddisplacements from R                    to R         , and Wf âˆˆ R                 is a projection matrix.
                                             âŠ™is summation.
                                             Intra-Primitive Point Transformer. In this stage, the lower-level feature
                                             is extracted by enhancing per-point features obtained from the 4D backbone
                                             in a geometry-aware way. point features are clustered in groups according to
                                             their primitive labels given in the primitive fitting phase. Compared with simply
                                             grouping by k-NN search in euclidean space [16], primitive-based partition has a
                                             more underlying geometric meaning such as normal consistency. As point clouds
                                             are sets embedded in a metric space, self-attention is a natural way to build
                                             connections among them. By optimizing point embeddings in a geometry-aware
                                             manner, our intra-primitive transformer takes advantage of local aggregation
                                             rather than global information exchange. It is more friendly to optimization than
                                             a global transformer because points within the primitive plane cannot communi-
                                             cate with points outside. After this step, points with similar geometric features
                                             are easier to align together, which facilitates subsequent higher-level feature ex-
                                             traction.
                                                                                                                        
                                                                                                                       e  er                       d
                                                                                                                m      iv y                m       r
                                                                                                                       it a                        a
                                                                                                                or         L     LU        or      w
                                                                                                                N      rimon     E         N       o
                                                                                                                       P  i                        F
                                                                                                                er     -  t      G         er
                                                                                                                y      ra en               y
                                                                                                                       t  t                        eed
                                                                                                                La     n  t                La      F
                                                                                                                       I  A
                                                                                         #1 Primitive
                                                                                         #2 Primitive                                                       Ã—í µí±™
                                                      Primitive Region                   #3 Primitive                                              Addition
                                             Fig.5. Left: primitive-based region partition. Points are divided into primitive
                                             regions according to primitive labels. Intra-primitive performs self-attention in one
                                             primitive region. Right: Intra-primitive transformer block. Consisting of intra-
                                             primitive attention layer, pre-LayerNorm [2], GELU [18] and residual connection [17].
                                                    Specifically, in the layer i, the enhanced point feature Fi                                of primitive
                                                                                                                                          out
                                             region i with input embedding set Fi is computed formally as [39]:
                                                                                                  in
                                                                         Q=W Â·Fi ,K=W Â·Fi ,V =W Â·Fi
                                                                                   q     in             k     in        v in
                                                                                                                            T                               (2)
                                                                           i                                              Q K
                                                                        F       =SA(Q,K,V)=softmax âˆš                               V
                                                                           out                                              Ck
                                             where Fi âˆˆ RCiÃ—Nâ€²Ã—LM, Ci,Nâ€²,L,M represents input dimension, point num-
                                                         in
                                             ber per primitive, clip length and primitive number respectively. W ,W                                           âˆˆ
                                                                                                                                                     q     k
