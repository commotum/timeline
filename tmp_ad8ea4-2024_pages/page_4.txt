                                                                         text window and improves its performance on long-
                    0.004                                                text tasks. Therefore, we will choose the context
                    0.003                                                windowextension methods with the least perturba-
                    equency0.002
                    r
                    F                                                    tion according to the rotary angle distribution on
                    0.001                                                different dimensions.
                    0.000
                    0.006
                                                                         3.2   Minimizing Distribution Disturbance
                    0.004
                    equency
                    r
                    F0.002                                               In this part, we derive the disturbance between
                    0.000                                                rotary angle distributions and minimizing the dis-
                          0       5        10      15       20           turbance to maintain the their consistency. Given a
                                          Rotation Angle
                                                                         LLMpre-trained on the sequence length of L with
                            Pre-Trained L=4K  Interpolation(s=2) L0=8K
                            Extraplolation L0=8K                         the rotary position embedding, the set of rotary an-
                                                                         gle distributions for all dimensions is denoted as
                 Figure 3: The learned rotary angle distributions of            n 0              d/2−1    o
                                                                         P = P (Θ),...,P              (Θ) . Extending the
                                                                           L       L            L
                 LLaMA2. We demonstrate the 6th and 22nd dimen-          context windowtoL′,thenewrotaryangledistribu-
                 sions during pre-training within the 4k length, and the                                                 ′
                                                                         tion set is P ′. We define the disturbance D(L ,L)
                 corresponding rotary angle distributions when extended              L
                                                                         between these two distributions P ′ and P as:
                 to 8k via interpolation and extrapolation, respectively.                                   L        L
                 Wesetthenumberofintervals to b = 360 and we only
                 display the first 24 intervals for clarity. The distributions              b−1
                 of full intervals are provided in appendix A.1.              i             X i ′           Fi(L′)+ϵ
                                                                           D(P ′,P )=           F (L)log k
                                                                                 L    L           k         Fi(L)+ϵ
                                                                                            k=0               k           (8)
                                b−1                                                             d/2−1              .
                                 P i                  i                                          X i
                 where there is     P (Θ∈Interval ) = 1.                    D(P ′,P ) = 2×            D(P ′,P ) d,
                                      L               k                          L    L                     L    L
                                k=0                                                              i=0
                    TakeLLaMA2-7Basanexample,whereL = 4k
                 and d = 128, we analyze the rotary angle distribu-
                 tion of pre-trained parameters. We demonstrate the      where ϵ is an extremely small number to prevent
                                                                         dividing 0 and Di(P ′,P ) is the KL divergence.
                 distributions in Figure 3, which vary significantly                           L   L
                 as the dimension changes. Whenextendingthecon-          For OOD rotary angles introduced by interpola-
                                    ′           ′                        tion or extrapolation, Di(P ′,P ) yields a high
                 text window to L , such as L = 8k, we consider                                       L    L
                 two scenarios for each dimension: interpolation         disturbance score due to the large value of Fi(L′).
                                                                                                                       k
                 with the scaling factor s = 2 and direct extrapola-     Thescore is low when Fi(L′) ≪ Fi(L), since the
                                                                                                  k           k
                 tion. Consistency of the distributions derived by       incomplete sampling from the pre-trained rotary
                 these two extension approaches with the original        angle distribution does not have a serious impact
                 distribution also changes with different dimensions.    during the inference stage.
                 As shown in Figure 3, the rotary angle distribu-           Nowwecanquantitativelycomparethesituation
                 tion of the interpolation enables better maintenance    in Figure 3 and we can further control the exten-
                 of consistency with the pre-trained distribution on     sion strategy in a fine-grained manner with the
                 the 6th dimension. When it comes to the 22nd            disturbance score, where the primary objective is
                 dimension, the situation is completely the oppo-        to minimize the disturbance, minD(P ′,P ). In
                 site. Furthermore, we observe that interpolation                                                L    L
                                                                         detail, we combine the two strategies: one is based
                 introduces too many OOD angles that are assigned        on PI, where we use s = L′/L to interpolate and
                 the frequency of 0 by the pre-trained distribution,     obtain the corresponding rotary angle distributions
                 challenging model’s generalization capability.          PI,andtheother involves directly extrapolating
                                                                            ′
                                                                           L
                    It’s worth noting that our observation is inline     to L′ with distributions PE . We minimize the dis-
                                                                                                     ′
                                                                                                   L
                 with the empirical strategies in YaRN (Peng et al.,     turbance score for each dimension independently,
                                                                                                     d/2−1
                 2023), where different dimensions have completely       since minD(P ′,P ) ∝         P minDi(P ′,P ),
                 different situations. Besides, distributional consis-                   L    L                      L    L
                                                                                                      i=0
                 tency is essential for mitigating the OOD issue,        via selecting interpolation or extrapolation based
                 which enables LLMs to generalize to longer con-         onthe score. Thus, we modify the rotary position
                                                                     7291
