                              Pre-trained            Extrapolation         scaling strategies to each dimension according to r .
                     1                                                                                                         i
                                                                           Given two threshold hyperparameters Î±,Î², YaRN
                   oPE0                                                    modifies the RoPE as follows:
                   R                                                                ï£±
                                                                                    ï£´
                                                                                      Î¸ /s,                    if r < Î±
                                                                                    ï£² i                            i
                     1                                                        Ë†
                                                                              Î¸i =    Î¸ ,                      if r > Î² ,    (4)
                      0                     4096                    8192            ï£´ i                            i
                              Interpolation                                         ï£³
                     1                                                                (1âˆ’Î³i)Î¸i/s+Î³iÎ¸i, otherwise
                                                                           wheresisthescalingfactorandÎ³ = (r âˆ’Î±)/(Î²âˆ’
                                                                                                              i     i
                   oPE(PI)0                                                Î±). As shown in eq. (4), extrapolation is used
                   R                                                       for high-frequency dimensions (r > Î²), while in-
                                                                                                               i
                     1                                                     terpolation is used for low-frequency dimensions
                      0                     8192                           (r < Î±). Others are deployed with NTK-aware
                                           Position                          i
                  Figure 2: An example of context window extension,        (bloc97, 2023b,a) methods. Peng et al. (2023) em-
                  where green and blue points denote pre-trained and       pirically suggest Î± = 1 and Î² = 32 for LLaMAs.
                  OODposition indices. Upper: Extrapolation directly       3 Method
                  models position indices with RoPE. Lower: Interpo-
                  lation mitigates the OOD problem of position indices     In this section, we first introduce how to estimate
                  while introducing unseen rotary angles (cross points).   the rotary angle distribution. Then, we propose a
                                                                           novel approach that extends the context window of
                  is the sequence length and d is the dimension of an      LLMsbyminimizingthedisturbance of the rotary
                  attention head. With trainable parameters W and          angle distribution.
                                                                 q
                  Wk,thetheattention logit qâŠ¤kn with RoPE can
                                                 m                         3.1   Rotary Angle Distribution
                  be calculate as follows:                                 LLMs generate language sequences by sam-
                           âŠ¤           d         âŠ¤    d
                         q k =(R W x ) (R W x )                            pling from the learned distribution p(x)           =
                           m n         m q m          n   k n       (2)    Q
                                     âŠ¤       d                                  p(x |x      ), where the position order is im-
                                =x WR Wx                                      m     m <m
                                     m q nâˆ’m k n                           plicitly controlled by position embedding. This
                           d           d T d                               meansthat changes in the distribution of position
                  where R        =(R ) R (Suetal.,2021).
                           nâˆ’m         m      n                            embedding will have an impact on the language
                  2.2   Position Interpolation (PI)                        distribution. Thus, we need to model this distribu-
                  Asshowninthelowerpart of Figure 2, PI (Chen              tion and maintain its consistency when extending
                  et al., 2023) suggests linear interpolation to all di-   the context window.
                                                                                                                           i
                  mensions to keep position indices within the pre-           As illustrated in eq. (1), rotary angles Î˜      =
                                                                                                                           m
                  trained range. When extending the context window         (mÎ¸ mod2Ï€) of a specific dimension i are fi-
                                                                               i
                               â€²                                   â€²       nite discrete numbers during the pre-training stage,
                  from L to L , with the scaling factor s = L /L,
                           Ë†                                 Ë†             since 0 â‰¤ m < L,m âˆˆ N. Considering them as
                  the new Î¸i is scaled correspondingly as Î¸i = Î¸i/s.
                  Although alleviating OOD position indices, this          sampled from the rotary angle distribution, we can
                  approach is likely to disturb the original periodicity   statistically estimate this distribution. We divide
                  and add unseen rotary angles.                            the rotary range [0,2Ï€) uniformly into b intervals,
                                                                           where the kth interval in ith dimension is defined:
                  2.3   YaRN                                                                i    2kÏ€ 2(k+1)Ï€
                                                                                    Interval =         ,               ,     (5)
                  Foreachdimensionpair(2i,2i+1)inRoPE,Peng                                  k       b         b
                  et al. (2023) define its wavelength as follows:          wherek = 0,...,bâˆ’1,wesetthedefaultvalueof
                                                              2i           b to 360. The frequency of rotary angles Fi(L) in
                        Î» =Î»          =2Ï€/Î¸ =2Ï€Â·10000d.             (3)                                                 k
                         2i     2i+1          i                            each interval is calculated as:
                                                                                                                        
                  YaRN (Peng et al., 2023) argues that high-                  i            i            i               	 
                                                                            F (L) =  Î˜ âˆˆInterval , âˆ€m âˆˆ [0,L)  L.
                  frequency dimensions should employ less scaling,            k            m            k
                  significantly improving the performance of posi-                                                           (6)
                  tional interpolation. They introduce the ratio r         Therefore, the discrete probability density function
                                                                      i    of rotary angle distribution at the ith dimension is:
                  between the original context size L and the wave-
                                                                                        i               i       i
                  length Î» , which is r = L/Î» , and apply different                   P (Î˜âˆˆInterval ) = F (L),               (7)
                           i            i        i                                      L               k      k
                                                                       7290
